<app-navbar></app-navbar>

<div class="contenedor-perfil">
  <div class="contenido">
    
    <!-- Encabezado -->
    <div class="encabezado">
      <h1>üë®‚Äç‚öïÔ∏è Mi Perfil Profesional</h1>
      <p>Administra tu informaci√≥n m√©dica</p>
    </div>

    <!-- Cargando -->
    <div *ngIf="cargando" class="cargando">
      <div class="spinner"></div>
      <p>Cargando perfil...</p>
    </div>

    <!-- Contenido del Perfil -->
    <div *ngIf="!cargando && usuario && doctor" class="tarjeta-perfil">
      
      <!-- Mensajes -->
      <div *ngIf="mensajeExito" class="alerta alerta-exito">
        ‚úÖ {{ mensajeExito }}
      </div>
      
      <div *ngIf="mensajeError" class="alerta alerta-error">
        ‚ö†Ô∏è {{ mensajeError }}
      </div>

      <!-- Avatar y Rol -->
      <div class="perfil-header">
        <div class="avatar-grande" *ngIf="!fotoPreview || fotoPreview === ''">
          {{ usuario.nombre.charAt(0) }}{{ usuario.apellido.charAt(0) }}
        </div>
        <img *ngIf="fotoPreview && fotoPreview !== ''" [src]="fotoPreview" alt="Foto de perfil" class="avatar-grande-foto">
        
        <div class="perfil-info">
          <h2>Dr(a). {{ usuario.nombre }} {{ usuario.apellido }}</h2>
          <span class="badge-especialidad">{{ doctor.especialidad }}</span>
        </div>
      </div>

      <!-- ==================== SECCI√ìN DE FOTO ==================== -->
      <div class="seccion-datos">
        <h3>üì∏ Foto de Perfil</h3>
        
        <div class="contenedor-foto">
          <div class="foto-preview-container">
            <div *ngIf="!fotoPreview || fotoPreview === ''" class="foto-placeholder">
              <span class="icono-foto">üì∑</span>
              <p>Sin foto</p>
            </div>
            <img *ngIf="fotoPreview && fotoPreview !== ''" [src]="fotoPreview" alt="Preview" class="foto-preview">
          </div>
          
          <div class="foto-controles">
            <input 
              type="file" 
              #fileInput 
              accept="image/jpeg,image/jpg,image/png,image/webp"
              (change)="onFileSelected($event)"
              style="display: none;"
            >
            
            <button 
              type="button"
              class="btn-seleccionar-foto"
              (click)="fileInput.click()"
              [disabled]="subiendoFoto"
            >
              üìÅ Seleccionar Foto
            </button>
            
            <button 
              *ngIf="fotoSeleccionada"
              type="button"
              class="btn-subir-foto"
              (click)="subirFoto()"
              [disabled]="subiendoFoto"
            >
              <span *ngIf="!subiendoFoto">üíæ Guardar Foto</span>
              <span *ngIf="subiendoFoto">Subiendo...</span>
            </button>
            
            <button 
              *ngIf="usuario.foto && usuario.foto !== ''"
              type="button"
              class="btn-eliminar-foto"
              (click)="eliminarFoto()"
              [disabled]="subiendoFoto"
            >
              üóëÔ∏è Eliminar Foto
            </button>
          </div>
          
          <p class="foto-info">
            ‚ÑπÔ∏è Formatos: JPG, PNG, WEBP ‚Ä¢ Tama√±o m√°ximo: 2MB
          </p>
        </div>
      </div>
      <!-- ==================== FIN SECCI√ìN DE FOTO ==================== -->

      <!-- Datos No Editables -->
      <div class="seccion-datos">
        <h3>üìß Informaci√≥n de Cuenta</h3>
        
        <div class="dato-fila">
          <span class="dato-label">Correo Electr√≥nico:</span>
          <span class="dato-valor">{{ usuario.email }}</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Rol:</span>
          <span class="dato-valor">üë®‚Äç‚öïÔ∏è Doctor</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Fecha de Registro:</span>
          <span class="dato-valor">{{ formatearFecha(usuario.fechaRegistro) }}</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">N√∫mero de Citas:</span>
          <span class="dato-valor">{{ doctor.numeroCitas || 0 }}</span>
        </div>

        <div class="dato-fila" *ngIf="doctor.calificacion">
          <span class="dato-label">Calificaci√≥n:</span>
          <span class="dato-valor">‚≠ê {{ doctor.calificacion.toFixed(1) }}</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Estado:</span>
          <span class="dato-valor">
            <span class="badge-estado activo">‚úÖ Activo</span>
          </span>
        </div>
      </div>

      <!-- Formulario Editable -->
      <div class="seccion-datos">
        <div class="seccion-header">
          <h3>‚úèÔ∏è Informaci√≥n Personal y Profesional</h3>
          <button 
            *ngIf="!modoEdicion" 
            class="btn-editar"
            (click)="activarEdicion()"
          >
            ‚úèÔ∏è Editar
          </button>
        </div>

        <form [formGroup]="formularioPerfil" (ngSubmit)="guardarCambios()">
          
          <!-- Datos Personales -->
          <div class="formulario-fila">
            <div class="grupo-formulario">
              <label for="nombre">Nombre *</label>
              <input 
                type="text" 
                id="nombre"
                formControlName="nombre"
                [disabled]="!modoEdicion"
                [class.error]="formularioPerfil.get('nombre')?.invalid && formularioPerfil.get('nombre')?.touched"
              >
              <span class="mensaje-error" *ngIf="formularioPerfil.get('nombre')?.invalid && formularioPerfil.get('nombre')?.touched">
                {{ obtenerMensajeError('nombre') }}
              </span>
            </div>

            <div class="grupo-formulario">
              <label for="apellido">Apellido *</label>
              <input 
                type="text" 
                id="apellido"
                formControlName="apellido"
                [disabled]="!modoEdicion"
                [class.error]="formularioPerfil.get('apellido')?.invalid && formularioPerfil.get('apellido')?.touched"
              >
              <span class="mensaje-error" *ngIf="formularioPerfil.get('apellido')?.invalid && formularioPerfil.get('apellido')?.touched">
                {{ obtenerMensajeError('apellido') }}
              </span>
            </div>
          </div>

          <div class="grupo-formulario">
            <label for="telefono">Tel√©fono *</label>
            <input 
              type="tel" 
              id="telefono"
              formControlName="telefono"
              maxlength="9"
              [disabled]="!modoEdicion"
              [class.error]="formularioPerfil.get('telefono')?.invalid && formularioPerfil.get('telefono')?.touched"
            >
            <span class="mensaje-error" *ngIf="formularioPerfil.get('telefono')?.invalid && formularioPerfil.get('telefono')?.touched">
              {{ obtenerMensajeError('telefono') }}
            </span>
          </div>

          <!-- Datos Profesionales -->
          <div class="formulario-fila">
            <div class="grupo-formulario">
              <label for="especialidad">Especialidad *</label>
              <select 
                id="especialidad"
                formControlName="especialidad"
                [disabled]="!modoEdicion"
                [class.error]="formularioPerfil.get('especialidad')?.invalid && formularioPerfil.get('especialidad')?.touched"
              >
                <option value="">Seleccione especialidad</option>
                <option *ngFor="let esp of especialidades" [value]="esp.nombre">
                  {{ esp.icono }} {{ esp.nombre }}
                </option>
              </select>
              <span class="mensaje-error" *ngIf="formularioPerfil.get('especialidad')?.invalid && formularioPerfil.get('especialidad')?.touched">
                {{ obtenerMensajeError('especialidad') }}
              </span>
            </div>

            <div class="grupo-formulario">
              <label for="consultorio">Consultorio *</label>
              <input 
                type="text" 
                id="consultorio"
                formControlName="consultorio"
                [disabled]="!modoEdicion"
                [class.error]="formularioPerfil.get('consultorio')?.invalid && formularioPerfil.get('consultorio')?.touched"
              >
              <span class="mensaje-error" *ngIf="formularioPerfil.get('consultorio')?.invalid && formularioPerfil.get('consultorio')?.touched">
                {{ obtenerMensajeError('consultorio') }}
              </span>
            </div>
          </div>

          <div class="grupo-formulario">
            <label for="a√±osExperiencia">A√±os de Experiencia *</label>
            <input 
              type="number" 
              id="a√±osExperiencia"
              formControlName="a√±osExperiencia"
              min="0"
              [disabled]="!modoEdicion"
              [class.error]="formularioPerfil.get('a√±osExperiencia')?.invalid && formularioPerfil.get('a√±osExperiencia')?.touched"
            >
            <span class="mensaje-error" *ngIf="formularioPerfil.get('a√±osExperiencia')?.invalid && formularioPerfil.get('a√±osExperiencia')?.touched">
              {{ obtenerMensajeError('a√±osExperiencia') }}
            </span>
          </div>

          <div class="grupo-formulario">
            <label for="biografia">Biograf√≠a Profesional *</label>
            <textarea 
              id="biografia"
              formControlName="biografia"
              rows="4"
              [disabled]="!modoEdicion"
              [class.error]="formularioPerfil.get('biografia')?.invalid && formularioPerfil.get('biografia')?.touched"
            ></textarea>
            <span class="mensaje-error" *ngIf="formularioPerfil.get('biografia')?.invalid && formularioPerfil.get('biografia')?.touched">
              {{ obtenerMensajeError('biografia') }}
            </span>
          </div>

          <!-- Botones de Edici√≥n -->
          <div *ngIf="modoEdicion" class="botones-edicion">
            <button 
              type="button" 
              class="btn-cancelar"
              (click)="cancelarEdicion()"
              [disabled]="guardando"
            >
              ‚ùå Cancelar
            </button>
            <button 
              type="submit" 
              class="btn-guardar"
              [disabled]="guardando || formularioPerfil.invalid"
            >
              <span *ngIf="!guardando">üíæ Guardar Cambios</span>
              <span *ngIf="guardando">Guardando...</span>
            </button>
          </div>

        </form>
      </div>

    </div>

  </div>
</div>

<!-- ==================== MODAL DE CONFIRMACI√É"N ==================== -->
<div *ngIf="mostrarModalEliminar" class="modal-overlay" (click)="cancelarEliminarFoto()">
  <div class="modal-contenido" (click)="$event.stopPropagation()">
    <div class="modal-icono">‚ö†Ô∏è</div>
    <h3 class="modal-titulo">Confirmar eliminaci√≥n</h3>
    <p class="modal-mensaje">¬øEst√°s seguro de eliminar tu foto de perfil?</p>
    
    <div class="modal-botones">
      <button class="modal-btn-cancelar" (click)="cancelarEliminarFoto()">
        ‚ùå Cancelar
      </button>
      <button class="modal-btn-eliminar" (click)="confirmarEliminarFoto()">
        üóëÔ∏è Eliminar
      </button>
    </div>
  </div>
</div>
<!-- ==================== FIN MODAL ==================== -->