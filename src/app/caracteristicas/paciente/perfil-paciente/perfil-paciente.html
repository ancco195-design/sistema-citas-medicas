<app-navbar></app-navbar>

<div class="contenedor-perfil">
  <div class="contenido">
    
    <!-- Encabezado -->
    <div class="encabezado">
      <h1>ğŸ‘¤ Mi Perfil</h1>
      <p>Administra tu informaciÃ³n personal</p>
    </div>

    <!-- Cargando -->
    <div *ngIf="cargando" class="cargando">
      <div class="spinner"></div>
      <p>Cargando perfil...</p>
    </div>

    <!-- Contenido del Perfil -->
    <div *ngIf="!cargando && usuario" class="tarjeta-perfil">
      
      <!-- Mensajes -->
      <div *ngIf="mensajeExito" class="alerta alerta-exito">
        âœ… {{ mensajeExito }}
      </div>
      
      <div *ngIf="mensajeError" class="alerta alerta-error">
        âš ï¸ {{ mensajeError }}
      </div>

      <!-- Avatar y Rol -->
      <div class="perfil-header">
        <div class="avatar-grande" *ngIf="!fotoPreview || fotoPreview === ''">
          {{ usuario.nombre.charAt(0) }}{{ usuario.apellido.charAt(0) }}
        </div>
        <img *ngIf="fotoPreview && fotoPreview !== ''" [src]="fotoPreview" alt="Foto de perfil" class="avatar-grande-foto">
        
        <div class="perfil-info">
          <h2>{{ usuario.nombre }} {{ usuario.apellido }}</h2>
          <span class="badge-rol">ğŸ‘¤ Paciente</span>
        </div>
      </div>

      <!-- ==================== SECCIÃ“N DE FOTO ==================== -->
      <div class="seccion-datos">
        <h3>ğŸ“¸ Foto de Perfil</h3>
        
        <div class="contenedor-foto">
          <div class="foto-preview-container">
            <div *ngIf="!fotoPreview || fotoPreview === ''" class="foto-placeholder">
              <span class="icono-foto">ğŸ“·</span>
              <p>Sin foto</p>
            </div>
            <img *ngIf="fotoPreview && fotoPreview !== ''" [src]="fotoPreview" alt="Preview" class="foto-preview">
          </div>
          
          <div class="foto-controles">
            <input 
              type="file" 
              #fileInput 
              accept="image/jpeg,image/jpg,image/png,image/webp"
              (change)="onFileSelected($event)"
              style="display: none;"
            >
            
            <button 
              type="button"
              class="btn-seleccionar-foto"
              (click)="fileInput.click()"
              [disabled]="subiendoFoto"
            >
              ğŸ“ Seleccionar Foto
            </button>
            
            <button 
              *ngIf="fotoSeleccionada"
              type="button"
              class="btn-subir-foto"
              (click)="subirFoto()"
              [disabled]="subiendoFoto"
            >
              <span *ngIf="!subiendoFoto">ğŸ’¾ Guardar Foto</span>
              <span *ngIf="subiendoFoto">Subiendo...</span>
            </button>
            
            <button 
              *ngIf="usuario.foto && usuario.foto !== ''"
              type="button"
              class="btn-eliminar-foto"
              (click)="eliminarFoto()"
              [disabled]="subiendoFoto"
            >
              ğŸ—‘ï¸ Eliminar Foto
            </button>
          </div>
          
          <p class="foto-info">
            â„¹ï¸ Formatos: JPG, PNG, WEBP â€¢ TamaÃ±o mÃ¡ximo: 2MB
          </p>
        </div>
      </div>
      <!-- ==================== FIN SECCIÃ“N DE FOTO ==================== -->

      <!-- Datos No Editables -->
      <div class="seccion-datos">
        <h3>ğŸ“§ InformaciÃ³n de Cuenta</h3>
        
        <div class="dato-fila">
          <span class="dato-label">Correo ElectrÃ³nico:</span>
          <span class="dato-valor">{{ usuario.email }}</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Rol:</span>
          <span class="dato-valor">ğŸ‘¤ Paciente</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Fecha de Registro:</span>
          <span class="dato-valor">{{ formatearFecha(usuario.fechaRegistro) }}</span>
        </div>

        <div class="dato-fila">
          <span class="dato-label">Estado:</span>
          <span class="dato-valor">
            <span class="badge-estado activo">âœ… Activo</span>
          </span>
        </div>
      </div>

      <!-- Formulario Editable -->
      <div class="seccion-datos">
        <div class="seccion-header">
          <h3>âœï¸ InformaciÃ³n Personal</h3>
          <button 
            *ngIf="!modoEdicion" 
            class="btn-editar"
            (click)="activarEdicion()"
          >
            âœï¸ Editar
          </button>
        </div>

        <form [formGroup]="formularioPerfil" (ngSubmit)="guardarCambios()">
          
          <div class="formulario-fila">
            <div class="grupo-formulario">
              <label for="nombre">Nombre *</label>
              <input 
                type="text" 
                id="nombre"
                formControlName="nombre"
                [class.error]="formularioPerfil.get('nombre')?.invalid && formularioPerfil.get('nombre')?.touched"
              >
              <span class="mensaje-error" *ngIf="formularioPerfil.get('nombre')?.invalid && formularioPerfil.get('nombre')?.touched">
                {{ obtenerMensajeError('nombre') }}
              </span>
            </div>

            <div class="grupo-formulario">
              <label for="apellido">Apellido *</label>
              <input 
                type="text" 
                id="apellido"
                formControlName="apellido"
                [class.error]="formularioPerfil.get('apellido')?.invalid && formularioPerfil.get('apellido')?.touched"
              >
              <span class="mensaje-error" *ngIf="formularioPerfil.get('apellido')?.invalid && formularioPerfil.get('apellido')?.touched">
                {{ obtenerMensajeError('apellido') }}
              </span>
            </div>
          </div>

          <div class="grupo-formulario">
            <label for="telefono">TelÃ©fono *</label>
            <input 
              type="tel" 
              id="telefono"
              formControlName="telefono"
              maxlength="9"
              [class.error]="formularioPerfil.get('telefono')?.invalid && formularioPerfil.get('telefono')?.touched"
            >
            <span class="mensaje-error" *ngIf="formularioPerfil.get('telefono')?.invalid && formularioPerfil.get('telefono')?.touched">
              {{ obtenerMensajeError('telefono') }}
            </span>
          </div>

          <!-- Botones de EdiciÃ³n -->
          <div *ngIf="modoEdicion" class="botones-edicion">
            <button 
              type="button" 
              class="btn-cancelar"
              (click)="cancelarEdicion()"
              [disabled]="guardando"
            >
              âŒ Cancelar
            </button>
            <button 
              type="submit" 
              class="btn-guardar"
              [disabled]="guardando || formularioPerfil.invalid"
            >
              <span *ngIf="!guardando">ğŸ’¾ Guardar Cambios</span>
              <span *ngIf="guardando">Guardando...</span>
            </button>
          </div>

        </form>
      </div>

    </div>

  </div>
</div>

<!-- ==================== MODAL DE CONFIRMACIÃ“N ==================== -->
<div *ngIf="mostrarModalEliminar" class="modal-overlay" (click)="cancelarEliminarFoto()">
  <div class="modal-contenido" (click)="$event.stopPropagation()">
    <div class="modal-icono">âš ï¸</div>
    <h3 class="modal-titulo">Confirmar eliminaciÃ³n</h3>
    <p class="modal-mensaje">Â¿EstÃ¡s seguro de eliminar tu foto de perfil?</p>
    
    <div class="modal-botones">
      <button class="modal-btn-cancelar" (click)="cancelarEliminarFoto()">
        âŒ Cancelar
      </button>
      <button class="modal-btn-eliminar" (click)="confirmarEliminarFoto()">
        ğŸ—‘ï¸ Eliminar
      </button>
    </div>
  </div>
</div>
<!-- ==================== FIN MODAL ==================== -->